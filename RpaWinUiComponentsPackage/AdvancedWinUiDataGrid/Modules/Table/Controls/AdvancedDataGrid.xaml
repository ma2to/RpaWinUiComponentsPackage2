<?xml version="1.0" encoding="utf-8"?>
<UserControl
    x:Class="RpaWinUiComponentsPackage.AdvancedWinUiDataGrid.Modules.Table.Controls.AdvancedDataGrid"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:converters="using:RpaWinUiComponentsPackage.AdvancedWinUiDataGrid.Modules.Table.Converters"
    mc:Ignorable="d"
    d:DesignHeight="300"
    d:DesignWidth="400"
    PointerMoved="DataGrid_PointerMoved"
    PointerReleased="DataGrid_PointerReleased"
    KeyDown="AdvancedDataGrid_KeyDown"
    IsTabStop="True"
    UseSystemFocusVisuals="True">

    <UserControl.Resources>
        <!-- Converters for cell editing visibility -->
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter" />
        <converters:BoolToVisibilityInverseConverter x:Key="BoolToVisibilityInverseConverter" />
        
        <!-- KVALITNÉ DATATEMPLATES - NO HARDCODED COLORS! Všetko programmaticky cez Binding -->
        
        <!-- Header template - properly bound to HeaderCellModel with resize capability -->
        <DataTemplate x:Key="HeaderTemplate">
            <Border x:Name="HeaderBorder"
                    BorderThickness="1"
                    Padding="6,4"
                    Background="{Binding BackgroundBrush}"
                    BorderBrush="{Binding BorderBrush}"
                    Width="{Binding Width}"
                    Height="32">
                <Grid>
                    <!-- Header text with proper typography -->
                    <TextBlock x:Name="HeaderText" 
                               Text="{Binding DisplayName}"
                               Foreground="{Binding ForegroundBrush}"
                               FontWeight="SemiBold"
                               VerticalAlignment="Center"
                               HorizontalAlignment="Left"
                               TextTrimming="CharacterEllipsis"
                               ToolTipService.ToolTip="{Binding DisplayName}" />
                    
                    <!-- Resize handle - ±2px od hrany bunky pre ľahšiu interakciu -->
                    <Rectangle x:Name="ResizeHandle"
                               Width="5"
                               HorizontalAlignment="Right"
                               Margin="0,0,-2.5,0"
                               Fill="Transparent"
                               PointerPressed="ResizeHandle_PointerPressed"
                               PointerMoved="ResizeHandle_PointerMoved"
                               PointerReleased="ResizeHandle_PointerReleased"
                               PointerEntered="ResizeHandle_PointerEntered"
                               PointerExited="ResizeHandle_PointerExited" />
                </Grid>
            </Border>
        </DataTemplate>

        <!-- Row template - s proper cell rendering -->
        <DataTemplate x:Key="RowTemplate">
            <Border x:Name="RowBorder"
                    Background="{Binding BackgroundBrush}"
                    BorderThickness="0,0,0,1"
                    BorderBrush="LightGray"
                    Height="{Binding Height}"
                    MinHeight="32">
                <!-- ItemsRepeater pre cells s horizontal layout -->
                <ItemsRepeater ItemsSource="{Binding Cells}"
                               ItemTemplate="{StaticResource CellTemplate}">
                    <ItemsRepeater.Layout>
                        <StackLayout Orientation="Horizontal" Spacing="0" />
                    </ItemsRepeater.Layout>
                </ItemsRepeater>
            </Border>
        </DataTemplate>

        <!-- Cell template - KVALITNÉ s editability, selection a focus -->
        <DataTemplate x:Key="CellTemplate">
            <Border x:Name="CellBorder"
                    BorderThickness="{Binding BorderThickness}"
                    Padding="6,2"
                    Background="{Binding BackgroundBrush}"
                    BorderBrush="{Binding BorderBrush}"
                    Width="{Binding Width}"
                    VerticalAlignment="Stretch"
                    MinHeight="32"
                    RightTapped="CellBorder_RightTapped"
                    PointerPressed="CellBorder_PointerPressed">
                <Grid>
                    <!-- Display mode - FULL CLICKABLE AREA with proper text wrapping -->
                    <Grid x:Name="DisplayArea"
                          Background="Transparent"
                          VerticalAlignment="Stretch"
                          HorizontalAlignment="Stretch"
                          Visibility="{Binding IsEditing, Converter={StaticResource BoolToVisibilityInverseConverter}}">
                        <TextBlock x:Name="DisplayText" 
                                   Text="{Binding DisplayText}"
                                   Foreground="{Binding ForegroundBrush}"
                                   VerticalAlignment="Stretch"
                                   HorizontalAlignment="Stretch"
                                   TextWrapping="Wrap"
                                   Margin="4,2,4,2"
                                   IsHitTestVisible="False"
                                   MaxLines="0" />
                    </Grid>
                    
                    <!-- Edit mode - TextBox with proper text wrapping -->
                    <TextBox x:Name="EditTextBox"
                             Text="{Binding DisplayText, Mode=TwoWay}"
                             Foreground="{Binding ForegroundBrush}"
                             BorderThickness="0"
                             Padding="4,2"
                             VerticalAlignment="Stretch"
                             HorizontalAlignment="Stretch"
                             Visibility="{Binding IsEditing, Converter={StaticResource BoolToVisibilityConverter}}"
                             LostFocus="EditTextBox_LostFocus"
                             KeyDown="EditTextBox_KeyDown"
                             TextChanged="EditTextBox_TextChanged"
                             IsSpellCheckEnabled="False"
                             IsTextPredictionEnabled="False"
                             AcceptsReturn="True"
                             TextWrapping="Wrap"
                             VerticalContentAlignment="Top"
                             ScrollViewer.VerticalScrollBarVisibility="Auto"
                             ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                             Header=""
                             PlaceholderText=""
                             ContextFlyout="{x:Null}" />
                </Grid>
            </Border>
        </DataTemplate>

    </UserControl.Resources>

    <Grid x:Name="RootGrid">
        <!-- Single ScrollViewer for synchronized header/data scrolling -->
        <ScrollViewer x:Name="MainScrollViewer"
                      HorizontalScrollBarVisibility="Auto"
                      VerticalScrollBarVisibility="Auto"
                      HorizontalScrollMode="Auto"
                      VerticalScrollMode="Auto"
                      ZoomMode="Disabled">
            <Grid x:Name="TableGrid">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" /> <!-- Header row -->
                    <RowDefinition Height="*" />    <!-- Data area -->
                </Grid.RowDefinitions>
                
                <!-- Column Headers - Fixed at top s KVALITNÝM HeaderTemplate -->
                <ItemsRepeater x:Name="HeaderRepeater"
                               Grid.Row="0"
                               ItemTemplate="{StaticResource HeaderTemplate}">
                    <ItemsRepeater.Layout>
                        <StackLayout Orientation="Horizontal" Spacing="0" />
                    </ItemsRepeater.Layout>
                </ItemsRepeater>

                <!-- Data Grid Area - VIRTUAL SCROLLING s KVALITNÝM RowTemplate -->
                <ItemsRepeater x:Name="DataRepeater"
                               Grid.Row="1"
                               ItemTemplate="{StaticResource RowTemplate}">
                    <ItemsRepeater.Layout>
                        <StackLayout Orientation="Vertical" />
                    </ItemsRepeater.Layout>
                </ItemsRepeater>
            </Grid>
        </ScrollViewer>
        
        <!-- Loading indicator overlay -->
        <ProgressRing x:Name="LoadingRing"
                      IsActive="False"
                      Visibility="Collapsed"
                      Width="50"
                      Height="50"
                      HorizontalAlignment="Center"
                      VerticalAlignment="Center" />

        <!-- Status bar overlay -->
        <Border x:Name="StatusBar"
                VerticalAlignment="Bottom"
                BorderThickness="0,1,0,0"
                Padding="8,4"
                Visibility="Collapsed">
            <TextBlock x:Name="StatusText"
                       Text="Ready"
                       FontSize="12" />
        </Border>
    </Grid>
</UserControl>