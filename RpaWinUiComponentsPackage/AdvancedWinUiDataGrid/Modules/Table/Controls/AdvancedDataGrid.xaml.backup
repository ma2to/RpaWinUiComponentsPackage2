<?xml version="1.0" encoding="utf-8"?>
<UserControl
    x:Class="RpaWinUiComponentsPackage.AdvancedWinUiDataGrid.Modules.Table.Controls.AdvancedDataGrid"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:converters="using:RpaWinUiComponentsPackage.AdvancedWinUiDataGrid.Modules.Table.Converters"
    mc:Ignorable="d"
    d:DesignHeight="300"
    d:DesignWidth="400">

    <UserControl.Resources>
        <!-- Converters for cell editing visibility -->
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter" />
        <converters:BoolToVisibilityInverseConverter x:Key="BoolToVisibilityInverseConverter" />
        
        <!-- Templates will be set programmatically from code - NO hardcoded colors! -->
        <!-- Header template - properly bound to HeaderCellModel -->
        <DataTemplate x:Key="HeaderTemplate">
            <Border x:Name="HeaderBorder"
                    BorderThickness="0,0,1,1"
                    Padding="6,4"
                    Background="{Binding BackgroundBrush}"
                    BorderBrush="{Binding BorderBrush}"
                    Width="{Binding Width}"
                    Height="32">
                <Grid>
                    <TextBlock x:Name="HeaderText" 
                               Text="{Binding DisplayName}"
                               Foreground="{Binding ForegroundBrush}"
                               FontWeight="SemiBold"
                               VerticalAlignment="Center"
                               HorizontalAlignment="Left" />
                    
                    <!-- Resize handle - invisible rectangle at right edge -->
                    <Rectangle x:Name="ResizeHandle"
                               Width="6"
                               HorizontalAlignment="Right"
                               Fill="Transparent"
                               PointerPressed="ResizeHandle_PointerPressed"
                               PointerMoved="ResizeHandle_PointerMoved"
                               PointerReleased="ResizeHandle_PointerReleased"
                               PointerEntered="ResizeHandle_PointerEntered"
                               PointerExited="ResizeHandle_PointerExited" />
                </Grid>
            </Border>
        </DataTemplate>

        <!-- Row template - properly bound to DataRowModel -->
        <DataTemplate x:Key="RowTemplate">
            <Border x:Name="RowBorder"
                    Background="{Binding BackgroundBrush}"
                    BorderThickness="0,0,0,1"
                    BorderBrush="LightGray"
                    Height="32">
                <ItemsRepeater ItemsSource="{Binding Cells}"
                               ItemTemplate="{StaticResource CellTemplate}">
                    <ItemsRepeater.Layout>
                        <StackLayout Orientation="Horizontal" Spacing="0" />
                    </ItemsRepeater.Layout>
                </ItemsRepeater>
            </Border>
        </DataTemplate>

        <!-- Cell template - properly bound to DataCellModel with edit capability -->
        <DataTemplate x:Key="CellTemplate">
            <Border x:Name="CellBorder"
                    BorderThickness="0,0,1,0"
                    Padding="6,2"
                    Background="{Binding BackgroundBrush}"
                    BorderBrush="{Binding BorderBrush}"
                    Width="{Binding Width}"
                    Height="32">
                <Grid>
                    <!-- Display mode - TextBlock - CLICKABLE FOR EDITING -->
                    <TextBlock x:Name="DisplayText" 
                               Text="{Binding DisplayText}"
                               Foreground="{Binding ForegroundBrush}"
                               VerticalAlignment="Center"
                               HorizontalAlignment="Stretch"
                               TextTrimming="CharacterEllipsis"
                               Margin="4,2,10,2"
                               Background="Transparent"
                               Visibility="{Binding IsEditing, Converter={StaticResource BoolToVisibilityInverseConverter}}"
                               Tapped="DisplayText_Tapped" />
                    
                    <!-- Edit mode - TextBox -->
                    <TextBox x:Name="EditTextBox"
                             Text="{Binding DisplayText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                             Foreground="{Binding ForegroundBrush}"
                             Background="Transparent"
                             BorderThickness="0"
                             Padding="4,2"
                             Margin="0,0,6,0"
                             VerticalAlignment="Center"
                             HorizontalAlignment="Stretch"
                             Visibility="{Binding IsEditing, Converter={StaticResource BoolToVisibilityConverter}}"
                             LostFocus="EditTextBox_LostFocus"
                             KeyDown="EditTextBox_KeyDown" />
                    
                    <!-- Resize handle - TOP LAYER, only at right edge -->
                    <Rectangle x:Name="CellResizeHandle"
                               Width="8"
                               HorizontalAlignment="Right"
                               Fill="Transparent"
                               PointerPressed="ResizeHandle_PointerPressed"
                               PointerMoved="ResizeHandle_PointerMoved"
                               PointerReleased="ResizeHandle_PointerReleased"
                               PointerEntered="ResizeHandle_PointerEntered"
                               PointerExited="ResizeHandle_PointerExited" />
                </Grid>
            </Border>
        </DataTemplate>

    </UserControl.Resources>

    <Grid x:Name="RootGrid">
        <!-- Single ScrollViewer for synchronized header/data scrolling -->
        <ScrollViewer x:Name="MainScrollViewer"
                      HorizontalScrollBarVisibility="Auto"
                      VerticalScrollBarVisibility="Auto"
                      ZoomMode="Disabled">
            <Grid x:Name="TableGrid">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" /> <!-- Header row -->
                    <RowDefinition Height="*" />    <!-- Data area -->
                </Grid.RowDefinitions>
                
                <!-- Column Headers - Fixed at top -->
                <ItemsRepeater x:Name="HeaderRepeater"
                               Grid.Row="0"
                               ItemTemplate="{StaticResource HeaderTemplate}">
                    <ItemsRepeater.Layout>
                        <StackLayout Orientation="Horizontal" Spacing="0" />
                    </ItemsRepeater.Layout>
                </ItemsRepeater>

                <!-- Data Grid Area -->
                <ItemsRepeater x:Name="DataRepeater"
                               Grid.Row="1"
                               ItemTemplate="{StaticResource RowTemplate}">
                    <ItemsRepeater.Layout>
                        <StackLayout Orientation="Vertical" />
                    </ItemsRepeater.Layout>
                </ItemsRepeater>
            </Grid>
        </ScrollViewer>
        
        <!-- Loading indicator overlay -->
        <ProgressRing x:Name="LoadingRing"
                      IsActive="False"
                      Visibility="Collapsed"
                      Width="50"
                      Height="50"
                      HorizontalAlignment="Center"
                      VerticalAlignment="Center" />

        <!-- Status bar overlay -->
        <Border x:Name="StatusBar"
                VerticalAlignment="Bottom"
                BorderThickness="0,1,0,0"
                Padding="8,4"
                Visibility="Collapsed">
            <TextBlock x:Name="StatusText"
                       Text="Ready"
                       FontSize="12" />
        </Border>
    </Grid>
</UserControl>